<!DOCTYPE html>
<html>
<head>
  <title>VATSIM Flights in Russia</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style> * { box-sizing: border-box; }
    @font-face {
        font-family: 'led_board_normal';
        src: url('led_board_normal.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
    }
    
    body {
        font-family: 'led_board_normal', sans-serif;
        color: orange; /* Оранжевый цвет текста */
        background-color: #333333; /* Цвет темного фона */
    }
h1 {
color: #ffdd00;
padding: 20px 0;
text-align: center;
margin: 0;
font-size: 2.5rem;
}

.flights-table, .controllers-table {
width: 100%;
margin: 20px auto;
border-collapse: collapse;
color: orange;
background-color: #212121;
overflow-x: auto;
font-size: 1rem;
}

#tables-container {
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
overflow: hidden;
width: 90%;
margin: 0 auto;
}

#controllers-container, #stats-container {
margin: 0 50px;
}

.site-content {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
width: 100%;
min-height: 100vh;
}

.flights-table th, .flights-table td, .controllers-table th, .controllers-table td {
border: 1px solid #ffdd00;
padding: 10px;
text-align: center;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
cursor: pointer;
font-size: 1rem;
}

.flights-table caption, .controllers-table caption {
border: 1px solid #ffdd00;
padding: 10px;
text-align: center;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
font-weight: bold;
cursor: pointer;
font-size: 1.2rem;
}

.flights-table th, .controllers-table th, .flights-table caption, .controllers-table caption {
background-color: #212121;
color: #ffdd00;
}

.flights-table tr:nth-child(even), .controllers-table tr:nth-child(even) {
background-color: #313131;
}

.flights-table tr:hover, .controllers-table tr:hover {
background-color: #414141;
}

.marquee {
position: relative;
overflow: hidden;
--offset: 20em;
--move-initial: calc(-25% + var(--offset));
--move-final: calc(-50% + var(--offset));
color: orange;
text-align: center;
}

.marquee span {
position: absolute;
width: 50%;
height: 50%;
transform: translateX(var(--move-initial));
animation: marquee 15s linear infinite;
}

@keyframes marquee {
0% {
transform: translateX(var(--move-initial));
}
100% {
transform: translateX(var(--move-final));
}
}

.flights-stats {
color: orange;
background-color: #212121;
border: 1px solid #ffdd00;
border-radius: 5px;
padding: 10px;
margin: 20px;
width: 100%;
max-width: 700px;
overflow-x: auto;
overflow-y: visible;
}

.flights-stats p {
margin: 5px 0;
font-size: 18px;
}

.flights-stats h2 {
font-size: 24px;
margin: 0;
}

.alert {
color: #f00;
font-size: 1.2rem;
}

@font-face {
font-family: 'led_board_normal';
src: url('led_board_normal.ttf') format('truetype');
font-weight: normal;
font-style: normal;
font-display: swap;
}

.flights-table, .controllers-table {
font-family: 'led_board_normal', sans-serif;
color: orange;
}

</style>

</head>
<body>
  <h1>VATSIM Flights in Russia</h1>

<div class="site-content">
    <div id="tables-container">
        <div id="stats-container"></div>
        <div id="controllers-container"></div>
    </div>
    <div id="flights-container"></div>  
  </div>  
  <script>
    $(document).ready(function() {
      var flightsData = [];
	  var sortDirectionControllers = {
  name: 'asc',
  callsign: 'asc',
  frequency: 'asc'
};
      var sortDirection = {
        name: 'asc',
        callsign: 'asc',
        departure: 'asc',
        arrival: 'asc',
        aircraft_short: 'asc',
        groundspeed: 'asc'
      };
      var lastSortedBy = null;  // последним добавили эту переменную
      var airlineReplace = {
        "SBI": "S7",
        "PBD": "Pobeda",
        "AFL": "Aeroflot",
        "SDM": "Rossiya",
        "VTK": "Vostok",
        "SVR": "Ural",
		"UTA": "Utair",
		"KZR": "Air Astana"
      };
	        var ICAOReplace = {}; // добавьте эту глобальную переменную в верхней части вашего кода

      function getICAOAirportsData() {
        return $.getJSON('ICAO_airport.json', function (data) {
            ICAOReplace = data;
        });
      }

var controllersData = [];

function getFlightsData() { 
  return $.get('https://data.vatsim.net/v3/vatsim-data.json').then(function(data) {
    flightsData = data.pilots;
    controllersData = data.controllers; // добавлено
    if (flightsData.length > 0 || controllersData.length > 0) { // изменено
      filterFlightsByAirport();
      filterControllersByPrefix();
    } else {
      $('<p>').text('No flights or controllers found.').addClass('alert').appendTo('#flights-container');
    }
    return [flightsData, controllersData]; // изменено
  });
}

      function getICAOData() {
        return $.getJSON('ICAO.json', function (data) {
            aircraftReplace = data;
        });
      }
	  
// функция для отбора У-диспетчеров
function filterControllersByPrefix() {
  controllersData = controllersData.filter(function(controller) {
    return controller.callsign.startsWith('U') && controller.callsign.length === 8;
  });
}

// Добавить данные в другую сторону таблицы
function renderControllersTable() {
  var table = $('<table>').addClass('controllers-table');
  var tableHeader = $('<tr>');
  $('<th>').text('Name').appendTo(tableHeader);
  $('<th>').text('Callsign').appendTo(tableHeader);
  $('<th>').text('Frequency').appendTo(tableHeader);
  
  tableHeader.appendTo(table);

  for (var i = 0; i < controllersData.length; i++) {
    var controller = controllersData[i];
    var row = $('<tr>');
    $('<td>').text(controller.name).appendTo(row);
    $('<td>').text(controller.callsign).appendTo(row);
    $('<td>').text(controller.frequency).appendTo(row);
    row.appendTo(table);
  }
  $('#controllers-container').empty().append(table);
}
// In your ready function adjust this part
getFlightsData().then(function() {
  renderStats();
  renderTable();
  renderControllersTable(); // add this line
});

	  // Call the function every 15 seconds
	  setInterval(function() {
		getFlightsData();
	  }, 15000); // 15 seconds converted to milliseconds

      function filterFlightsByAirport() {
        flightsData = flightsData.filter(function(flight) {
          return (
            flight.flight_plan &&
            flight.flight_plan.departure &&
            flight.flight_plan.arrival &&
            flight.flight_plan.departure.startsWith('U') &&
            flight.flight_plan.arrival.startsWith('U')
          );
        });
      }


      function renderStats() {
        var totalPilots = flightsData.length;
        var totalControllers = controllersData.length;
        var airlinePilots = {};

        flightsData.forEach(function (flight) {
          var airlineCode = flight.callsign.substring(0, 3);
          if (airlinePilots[airlineCode]) {
            airlinePilots[airlineCode]++;
          } else {
            airlinePilots[airlineCode] = 1;
          }
        });

        var topAirlines = Object.entries(airlinePilots)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([airline, count]) => {
          airline = airlineReplace[airline] ? airlineReplace[airline] : airline;
          return airline + ' (' + count + ' pilots)';
        });

    var allAirports = { departures: {}, arrivals: {} };

    flightsData.forEach(function (flight) {
        var departureAirport = flight.flight_plan.departure;
        var arrivalAirport = flight.flight_plan.arrival;

        allAirports.departures[departureAirport] = (allAirports.departures[departureAirport] || 0) + 1;
        allAirports.arrivals[arrivalAirport] = (allAirports.arrivals[arrivalAirport] || 0) + 1;
    });

    function top3Dict(dict) {
        return Object.entries(dict)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([airport, count]) => `${airport} (${count} pilots)`);
    }

var top3DepartureAirports = Object.entries(allAirports.departures)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([airport, count]) => `${ICAOReplace[airport] || airport} (${count} pilots)`);
    var top3ArrivalAirports = Object.entries(allAirports.arrivals)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([airport, count]) => `${ICAOReplace[airport] || airport} (${count} pilots)`);

    var aircraftsCounts = {};

    flightsData.forEach(function (flight) {
        var aircraft = flight.flight_plan.aircraft_short;

        // Преобразуйте A20N в A320
        if (aircraft === 'A20N') {
            aircraft = 'A20N';
        }

        aircraftsCounts[aircraft] = (aircraftsCounts[aircraft] || 0) + 1;
    });

    var top3Aircrafts = Object.entries(aircraftsCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3)
    .map(([aircraft, count]) => {
        // Заменить код самолета на имя, если имя существует в aircraftReplace 
        aircraft = aircraftReplace[aircraft] ? aircraftReplace[aircraft] : aircraft; 
        return `${aircraft} (${count} pilots)`;
    });


    var stats = $('<div>').addClass('flights-stats');
    $('<h2>').text('Flight Statistics').appendTo(stats);
    $('<p>').text('Total pilots: ' + totalPilots).appendTo(stats);
	$('<p>').text('Total controllers: ' + totalControllers).appendTo(stats);
    $('<p>').text('Top 3 departure airports: ' + top3DepartureAirports.join(', ')).appendTo(stats);
    $('<p>').text('Top 3 arrival airports: ' + top3ArrivalAirports.join(', ')).appendTo(stats);
    $('<p>').text('Top 3 aircrafts by pilots: ' + top3Aircrafts.join(', ')).appendTo(stats);
        $('<p>').text('Top 3 airlines by pilots: ' + topAirlines.join(', ')).appendTo(stats);
        $('#stats-container').empty().append(stats);
      }

setInterval(renderStats, 5000);


	
      function getTop3(array) {
  var counts = {};
  for (var i = 0; i < array.length; i++) {
    var num = array[i];

    // Преобразуйте A20N в A320
    if (num === 'A20N') {
      num = 'A20N';
    }

    counts[num] = counts[num] ? counts[num] + 1 : 1;
  }
  return Object.keys(counts).sort(function(a, b) { return counts[b] - counts[a]; }).slice(0, 3);
}


function renderTable() {
  $('#flights-container').empty(); // очистить контейнер перед рисованием новой таблицы
  var table = $('<table>').addClass('flights-table');
    var caption = $('<caption>').text('Flights'); // Замените 'Список рейсов' на желаемый заголовок
    table.append(caption);
    var tableHeader = $('<tr>');
    $('<th>').text('Pilot').click(sortTableBy('name')).appendTo(tableHeader);
    $('<th>').text('Callsign').click(sortTableBy('callsign')).appendTo(tableHeader);
    $('<th>').text('Departure').click(sortTableBy('departure')).appendTo(tableHeader);
    $('<th>').text('Arrival').click(sortTableBy('arrival')).appendTo(tableHeader);
    $('<th>').text('Aircraft').click(sortTableBy('aircraft_short')).appendTo(tableHeader);
    $('<th>').text('Groundspeed').click(sortTableBy('groundspeed')).appendTo(tableHeader);
    $('<th>').text('Transponder').click(sortTableBy('transponder')).appendTo(tableHeader);
    $('<th>').text('Altitude').click(sortTableBy('altitude')).appendTo(tableHeader);
    tableHeader.appendTo(table);

    for (var i = 0; i < flightsData.length; i++) {
      var flight = flightsData[i];
      if (flight.flight_plan && flight.flight_plan.departure && flight.flight_plan.arrival && flight.flight_plan.aircraft_short) {
        var row = $('<tr>');
        // Добавляем условие, что если транспондер равен 2200, тогда добавляем к строке класс .red-highlight
        if (flight.transponder === "7700") {
          row.addClass('red-highlight');
        }
        $('<td>').text(flight.name.replace(/\b[A-Z]{4}\b/g, '').trim()).appendTo(row);
        $('<td>').text(flight.callsign).appendTo(row);
		$('<td>').text(ICAOReplace[flight.flight_plan.departure] || flight.flight_plan.departure).appendTo(row);
        $('<td>').text(ICAOReplace[flight.flight_plan.arrival] || flight.flight_plan.arrival).appendTo(row);

        var aircraft = flight.flight_plan.aircraft_short;
        // Check if the aircraft code should be replaced
        aircraft = aircraftReplace[aircraft] ? aircraftReplace[aircraft] : aircraft;

        $('<td>').text(aircraft).appendTo(row);

        $('<td>').text(flight.groundspeed).appendTo(row);
        $('<td>').text(flight.transponder).appendTo(row);
        $('<td>').text(flight.altitude).appendTo(row);
        row.appendTo(table);
      }
    }
    table.appendTo('#flights-container');
}


	  
	  
	  
function sortTableBy(property) {
        return function() {
          sortDirection[property] = sortDirection[property] === 'asc' ? 'desc' : 'asc';
          lastSortedBy = property;  // сохранение свойства последней сортировки

          flightsData.sort(getSortFunctionBy(lastSortedBy));

          $('#flights-container').empty();
          renderTable();
        };
      }

      // Добавили новую функцию getSortFunctionBy
      function getSortFunctionBy(property) {
        return function(a, b) {
          var valueA = property === 'departure' || property === 'arrival' || property === 'aircraft_short' ? (a.flight_plan ? a.flight_plan[property] : '') : a[property];
          var valueB = property === 'departure' || property === 'arrival' || property === 'aircraft_short' ? (b.flight_plan ? b.flight_plan[property] : '') : b[property];
          
          if (!valueA) valueA = '';
          if (!valueB) valueB = '';

          if (valueA < valueB) {
            return sortDirection[property] === 'asc' ? -1 : 1;
          }
          if (valueA > valueB) {
            return sortDirection[property] === 'asc' ? 1 : -1;
          }
          return 0;
        };
      }

      getFlightsData().then(function() {
        renderStats();
        renderTable();
      });
    function updateTable() {
        $.when(getFlightsData(), getICAOData(), getICAOAirportsData()).then(function() { // добавьте здесь `getICAOAirportsData()`
          renderStats();
          if(lastSortedBy !== null) {
            flightsData.sort(getSortFunctionBy(lastSortedBy)); // вызываем функцию, которая возвращает функцию сортировки, и применяем ее к массиву данных.
          }
          renderTable();
		  renderControllersTable();
        });
      }

      getFlightsData().then(function() {
        renderStats();
        renderTable();
      });

      // First call update function to populate the table
      updateTable();

      // Then set automatic table updates every 5 seconds
      setInterval(updateTable, 5000);
    });
  </script>
</body>
</html>
