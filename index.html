<!DOCTYPE html>
<html>
<head>
  <title>Vatstats: Russia</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style> 
@font-face {
  font-family: 'led_stadion';  /* Имя выбрано произвольно */
  src: url('led_stadion_7.ttf') format('truetype'); /* Путь к файлу шрифта */
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

body {
    background-color: black; /* Делаем фон страницы черным */
    font-family: 'led_stadion'; /* Применяем новый шрифт ко всем элементам */
    color: orange; /* Измененный цвет шрифта */
}
    h1 {
        color: #ffffff;
        padding: 20px 0;
        text-align: center;
        margin: 0;
        font-size: 4rem; /* Увеличенный размер шрифта*/
    }

.flights-table {
    width: 100%;
    margin: 20px auto;
    border-collapse: collapse;
    border: 1px solid orange; /* Черный цвет границ блока со статистикой */
    color: transparent;
    background-color: transparent; /* замените белый цвет фона на прозрачный */
    overflow-x: auto;
    font-size: 2rem; /* Увеличенный размер шрифта */
}

.controllers-table {
    width: 100%;
    margin: 20px auto;
    border-collapse: collapse;
    border: 1px solid orange; /* Черный цвет границ блока со статистикой */
    color: transparent;
    background-color: transparent; /* замените белый цвет фона на прозрачный */
    overflow-x: auto;
    font-size: 2rem; /* Увеличенный размер шрифта */
}
	
    #tables-container {
        display: flex;
        flex-direction: row;
        justify-content: center;
        overflow: hidden;
        width: 90%;
        margin: 0 auto;
        align-content: center;
        align-items: flex-start;
    }


    #controllers-container, #stats-container {
        margin: 0 50px;
    }

    .site-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        min-height: 100vh;
    }

.flights-table th, .controllers-table th {
    padding: 2px; /* Добавим отступы внутри ячеек */
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
    font-size: 2rem; /* Уменьшим размер шрифта для улучшения читаемости */
}

.flights-table td, .controllers-table td {
    padding: 2px; /* Добавим отступы внутри ячеек */
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    cursor: pointer;
    font-size: 2rem; /* Уменьшим размер шрифта для улучшения читаемости */
}

.flights-table caption, .controllers-table caption {
    padding: 2px; /* Добавим отступы внутри блоков */
    border: 1px solid orange; /* Черный цвет границ блока со статистикой */
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: bold;
    cursor: pointer;
    font-size: 2.5rem; /* Увеличение размера шрифта */
}

    .flights-table th, .controllers-table th, .flights-table caption, .controllers-table caption {
        background-color: transparent; /* замените белый цвет фона на прозрачный */
        color: orange; /* Темный цвет текста заголовка таблицы */
    }

    .flights-table tr:nth-child(even), .controllers-table tr:nth-child(even) {
        background-color: transparent; /* замените белый цвет фона на прозрачный */
    }

    .flights-table tr:hover, .controllers-table tr:hover {
        background-color: transparent; /* замените белый цвет фона на прозрачный */
    }
    
.flights-stats {
    color: #ffffff;
    background-color: transparent; /* замените белый цвет фона на прозрачный */
    border: 1px solid orange; /* Черный цвет границ блока со статистикой */
    border-radius: 5px;
    padding: 10px;
    margin: 20px;
    width: 100%;
    max-width: 700px;
    overflow-x: auto;
    overflow-y: visible;
}

    .flights-stats p {
        margin: 5px 0;
        font-size: 32px;
	color: orange;
    }

    .flights-stats h2 {
        font-size: 44px;
        margin: 0;
	color: orange;
    }

    .alert {
        color: #f00;
        font-size: 1.2rem;
    }

.flights-table, .controllers-table {
    font-family: 'led_stadion', sans-serif;
    color: orange;   /* Цвет текста таблицы - белый */
}

    /* стили для главной метки на странице */
    .red-highlight {
      background-color: transparent; /* замените белый цвет фона на прозрачный */
      color: #ff4444; /* Белый цвет текста для условной выделенной строки */
    }

</style>

</head>
<body>
  <h1>VATSIM Flights in Russia</h1>

<div class="site-content">
    <div id="tables-container">
        <div id="stats-container"></div>
        <div id="controllers-container"></div>
    </div>
    <div id="flights-container"></div>  
  </div>  
  <script>
    $(document).ready(function() {
      var flightsData = [];
	  var sortDirectionControllers = {
  name: 'asc',
  callsign: 'asc',
  frequency: 'asc'
};
      var sortDirection = {
        name: 'asc',
        callsign: 'asc',
        departure: 'asc',
        arrival: 'asc',
        aircraft_short: 'asc',
        groundspeed: 'asc'
      };
      var lastSortedBy = null;  // последним добавили эту переменную
      var airlineReplace = {
        "SBI": "S7 Airlines",
        "PBD": "Pobeda",
        "AFL": "Aeroflot",
        "SDM": "Rossiya",
        "VTK": "Vostok",
        "SVR": "Ural",
	"UTA": "Utair",
	"KZR": "Air Astana"
      };
	        var ICAOReplace = {}; // добавьте эту глобальную переменную в верхней части вашего кода

      function getICAOAirportsData() {
        return $.getJSON('ICAO_airport.json', function (data) {
            ICAOReplace = data;
        });
      }

var controllersData = [];

function getFlightsData() { 
  return $.get('https://data.vatsim.net/v3/vatsim-data.json').then(function(data) {
    flightsData = data.pilots;
    controllersData = data.controllers; // добавлено
    if (flightsData.length > 0 || controllersData.length > 0) { // изменено
      filterFlightsByAirport();
      filterControllersByPrefix();
    } else {
      $('<p>').text('No flights or controllers found.').addClass('alert').appendTo('#flights-container');
    }
    return [flightsData, controllersData]; // изменено
  });
}

      function getICAOData() {
        return $.getJSON('ICAO.json', function (data) {
            aircraftReplace = data;
        });
      }
	  
// функция для отбора У-диспетчеров
function filterControllersByPrefix() {
  controllersData = controllersData.filter(function(controller) {
    return controller.callsign.startsWith('U') && controller.callsign.length === 8;
  });
}

// Добавить данные в другую сторону таблицы
function renderControllersTable() {
  var table = $('<table>').addClass('controllers-table');
  var caption = $('<caption>').text('Controllers'); // Замените 'Список рейсов' на желаемый заголовок
  table.append(caption);
  var tableHeader = $('<tr>');
  $('<th>').text('Name').appendTo(tableHeader);
  $('<th>').text('Callsign').appendTo(tableHeader);
  $('<th>').text('Frequency').appendTo(tableHeader);
  
  tableHeader.appendTo(table);

  for (var i = 0; i < controllersData.length; i++) {
    var controller = controllersData[i];
    var row = $('<tr>');
    $('<td>').text(controller.name).appendTo(row);
    $('<td>').text(controller.callsign).appendTo(row);
    $('<td>').text(controller.frequency).appendTo(row);
    row.appendTo(table);
  }
  $('#controllers-container').empty().append(table);
}
// In your ready function adjust this part
getFlightsData().then(function() {
  renderStats();
  renderTable();
  renderControllersTable(); // add this line
});

	  // Call the function every 15 seconds
	  setInterval(function() {
		getFlightsData();
	  }, 15000); // 15 seconds converted to milliseconds

      function filterFlightsByAirport() {
        flightsData = flightsData.filter(function(flight) {
          return (
            flight.flight_plan &&
            flight.flight_plan.departure &&
            flight.flight_plan.arrival &&
            flight.flight_plan.departure.startsWith('U') &&
            flight.flight_plan.arrival.startsWith('U')
          );
        });
      }


      function renderStats() {
        var totalPilots = flightsData.length;
        var totalControllers = controllersData.length;
        var airlinePilots = {};

        flightsData.forEach(function (flight) {
          var airlineCode = flight.callsign.substring(0, 3);
          if (airlinePilots[airlineCode]) {
            airlinePilots[airlineCode]++;
          } else {
            airlinePilots[airlineCode] = 1;
          }
        });

        var topAirlines = Object.entries(airlinePilots)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([airline, count]) => {
          airline = airlineReplace[airline] ? airlineReplace[airline] : airline;
          return airline + ' (' + count + ' pilots)';
        });

    var allAirports = { departures: {}, arrivals: {} };

    flightsData.forEach(function (flight) {
        var departureAirport = flight.flight_plan.departure;
        var arrivalAirport = flight.flight_plan.arrival;

        allAirports.departures[departureAirport] = (allAirports.departures[departureAirport] || 0) + 1;
        allAirports.arrivals[arrivalAirport] = (allAirports.arrivals[arrivalAirport] || 0) + 1;
    });

    function top3Dict(dict) {
        return Object.entries(dict)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([airport, count]) => `${airport} (${count} pilots)`);
    }

var top3DepartureAirports = Object.entries(allAirports.departures)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([airport, count]) => `${ICAOReplace[airport] || airport} (${count} pilots)`);
    var top3ArrivalAirports = Object.entries(allAirports.arrivals)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([airport, count]) => `${ICAOReplace[airport] || airport} (${count} pilots)`);

    var aircraftsCounts = {};

    flightsData.forEach(function (flight) {
        var aircraft = flight.flight_plan.aircraft_short;

        // Преобразуйте A20N в A320
        if (aircraft === 'A20N') {
            aircraft = 'A20N';
        }

        aircraftsCounts[aircraft] = (aircraftsCounts[aircraft] || 0) + 1;
    });

    var top3Aircrafts = Object.entries(aircraftsCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3)
    .map(([aircraft, count]) => {
        // Заменить код самолета на имя, если имя существует в aircraftReplace 
        aircraft = aircraftReplace[aircraft] ? aircraftReplace[aircraft] : aircraft; 
        return `${aircraft} (${count} pilots)`;
    });


  var stats = $('<div>').addClass('flights-stats');
  $('<h2>').text('Flight Statistics').appendTo(stats);
  $('<p>').html('Total pilots: ' + totalPilots + '<br>').appendTo(stats);
  $('<p>').html('Total controllers: ' + totalControllers + '<br>'+'<br>').appendTo(stats);
  $('<p>').html('Top 3 departure: '+'<br>' + top3DepartureAirports.join(',<br>') + '<br>'+'<br>').appendTo(stats);
  $('<p>').html('Top 3 arrival: '+'<br>' + top3ArrivalAirports.join(',<br>') + '<br>'+'<br>').appendTo(stats);
  $('<p>').html('Top 3 aircrafts: '+'<br>' + top3Aircrafts.join(',<br>') + '<br>'+'<br>').appendTo(stats);
  $('<p>').html('Top 3 airlines: '+'<br>' + topAirlines.join(',<br>') + '<br>').appendTo(stats);
  $('#stats-container').empty().append(stats);
}

setInterval(renderStats, 5000);


	
      function getTop3(array) {
  var counts = {};
  for (var i = 0; i < array.length; i++) {
    var num = array[i];

    // Преобразуйте A20N в A320
    if (num === 'A20N') {
      num = 'A20N';
    }

    counts[num] = counts[num] ? counts[num] + 1 : 1;
  }
  return Object.keys(counts).sort(function(a, b) { return counts[b] - counts[a]; }).slice(0, 3);
}


function renderTable() {
  $('#flights-container').empty(); // очистить контейнер перед рисованием новой таблицы
  var table = $('<table>').addClass('flights-table');
    var caption = $('<caption>').text('Flights'); // Замените 'Список рейсов' на желаемый заголовок
    table.append(caption);
    var tableHeader = $('<tr>');
    
    $('<th>').text('Callsign').click(sortTableBy('callsign')).appendTo(tableHeader);
    $('<th>').text('Departure').click(sortTableBy('departure')).appendTo(tableHeader);
    $('<th>').text('Arrival').click(sortTableBy('arrival')).appendTo(tableHeader);
    $('<th>').text('Aircraft').click(sortTableBy('aircraft_short')).appendTo(tableHeader);
    $('<th>').text('Transponder').click(sortTableBy('transponder')).appendTo(tableHeader);
    
    tableHeader.appendTo(table);

    for (var i = 0; i < flightsData.length; i++) {
      var flight = flightsData[i];
      if (flight.flight_plan && flight.flight_plan.departure && flight.flight_plan.arrival && flight.flight_plan.aircraft_short) {
        var row = $('<tr>');
        // Добавляем условие, что если транспондер равен 2200, тогда добавляем к строке класс .red-highlight
        if (flight.transponder === "7700") {
          row.addClass('red-highlight');
        }
        
        $('<td>').text(flight.callsign).appendTo(row);
		$('<td>').text(ICAOReplace[flight.flight_plan.departure] || flight.flight_plan.departure).appendTo(row);
        $('<td>').text(ICAOReplace[flight.flight_plan.arrival] || flight.flight_plan.arrival).appendTo(row);

        var aircraft = flight.flight_plan.aircraft_short;
        // Check if the aircraft code should be replaced
        aircraft = aircraftReplace[aircraft] ? aircraftReplace[aircraft] : aircraft;

        $('<td>').text(aircraft).appendTo(row);
        $('<td>').text(flight.transponder).appendTo(row);
        row.appendTo(table);
      }
    }
    table.appendTo('#flights-container');
}


	  
	  
	  
function sortTableBy(property) {
        return function() {
          sortDirection[property] = sortDirection[property] === 'asc' ? 'desc' : 'asc';
          lastSortedBy = property;  // сохранение свойства последней сортировки

          flightsData.sort(getSortFunctionBy(lastSortedBy));

          $('#flights-container').empty();
          renderTable();
        };
      }

      // Добавили новую функцию getSortFunctionBy
      function getSortFunctionBy(property) {
        return function(a, b) {
          var valueA = property === 'departure' || property === 'arrival' || property === 'aircraft_short' ? (a.flight_plan ? a.flight_plan[property] : '') : a[property];
          var valueB = property === 'departure' || property === 'arrival' || property === 'aircraft_short' ? (b.flight_plan ? b.flight_plan[property] : '') : b[property];
          
          if (!valueA) valueA = '';
          if (!valueB) valueB = '';

          if (valueA < valueB) {
            return sortDirection[property] === 'asc' ? -1 : 1;
          }
          if (valueA > valueB) {
            return sortDirection[property] === 'asc' ? 1 : -1;
          }
          return 0;
        };
      }

      getFlightsData().then(function() {
        renderStats();
        renderTable();
      });
    function updateTable() {
        $.when(getFlightsData(), getICAOData(), getICAOAirportsData()).then(function() { // добавьте здесь `getICAOAirportsData()`
          renderStats();
          if(lastSortedBy !== null) {
            flightsData.sort(getSortFunctionBy(lastSortedBy)); // вызываем функцию, которая возвращает функцию сортировки, и применяем ее к массиву данных.
          }
          renderTable();
		  renderControllersTable();
        });
      }

      getFlightsData().then(function() {
        renderStats();
        renderTable();
      });

      // First call update function to populate the table
      updateTable();

      // Then set automatic table updates every 5 seconds
      setInterval(updateTable, 5000);
    });
  </script>
</body>
</html>
